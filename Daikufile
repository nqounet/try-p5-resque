use Path::Tiny qw(path tempdir);
use Capture::Tiny qw(capture_stdout);
use App::scan_prereqs_cpanfile;

use Test::RedisServer;
use Proclet;

$ENV{TMPDIR} = '/tmp/mnt';


desc 'serve';
task serve => sub {
    sh qw(daiku hdiutil:detach);
    sh qw(daiku hdiutil:attach);
    sh qw(perl main.pl);
};

desc 'install perl modules';
task install => sub {
    sh q(cpanm --with-recommends --with-develop --with-all-features --installdeps .);
};

namespace generate => sub {
    desc 'generate cpanfile';
    task cpanfile => sub {
        my $stdout = capture_stdout sub {
            sh q(scan-prereqs-cpanfile --ignore=public,templates,var);
        };
        path('cpanfile')->spew($stdout);
    };
};

namespace carton => sub {
    desc 'carton install';
    task install => sub {
        sh qw(daiku generate:cpanfile);
        sh qw(carton install);
    };
};

namespace hdiutil => sub {
    my $dir = '/tmp/mnt';
    task attach => sub {
        my $drive = capture_stdout sub {
            sh q{hdiutil attach -nomount ram://1024000};
        };
        chomp $drive;
        sh qq{newfs_hfs $drive};
        sh qq{mkdir $dir} unless -d $dir;
        sh qq{mount -t hfs $drive $dir};
    };
    task detach => sub {
        my $info = capture_stdout sub {
            sh q{hdiutil info};
        };
        my $drive;
        for my $line (split /\n/, $info) {
            next unless $line =~ /$dir/ms;
            ($drive) = $line =~ /\A([^\s]+)\s/ms;
            last;
        }
        return unless $drive;
        sh qq{echo 'detach $drive ...'};
        sh qq{hdiutil detach $drive};
    };
};

task default => sub { sh q{daiku -T} };
